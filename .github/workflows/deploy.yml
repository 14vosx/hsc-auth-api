name: Deploy (Lightsail)

on:
  push:
    tags:
      - "v*"
      - "release-*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag para deploy (ex: v0.1.4 ou release-YYYYMMDD-HHMMSS)"
        required: false
        type: string
      rollback:
        description: "Executar rollback para a tag anterior (usa state file no servidor)"
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH Deploy to Lightsail
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            set -e
            if [ "${{ github.event_name }}" = "push" ]; then
              TAG="${{ github.ref_name }}"
              /opt/hsc/deploy-auth.sh "$TAG"
            else
              if [ "${{ inputs.rollback }}" = "true" ]; then
                /opt/hsc/deploy-auth.sh --rollback
              else
                if [ -z "${{ inputs.tag }}" ]; then
                  echo "‚ùå workflow_dispatch requer inputs.tag OU inputs.rollback=true"
                  exit 1
                fi
                /opt/hsc/deploy-auth.sh "${{ inputs.tag }}"
              fi
            fi
